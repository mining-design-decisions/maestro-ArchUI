{% extends 'base.html' %}

{% block subtitle %}{{action.title()}} Model{% endblock %}

{% macro render_tab_header(name, title, active=false, visible=true) %}
    {% if visible %}
    <li class="nav-item" role="presentation" id="{{name}}-tab-header">
    {% else %}
    <li class="nav-item d-none" role="presentation" id="{{name}}-tab-header">
    {% endif %}
        {% if active %}
        <button class="nav-link active" id="{{name}}-tab" data-bs-toggle="tab" data-bs-target="#{{name}}" type="button" role="tab" aria-controls="{{name}}" aria-selected="true">{{title}}</button>
        {% else %}
        <button class="nav-link" id="{{name}}-tab" data-bs-toggle="tab" data-bs-target="#{{name}}" type="button" role="tab" aria-controls="{{name}}" aria-selected="false">{{title}}</button>
        {% endif %}
    </li>
{% endmacro %}


{% macro render_tab(name, active=false) %}
    {% set show_active = "show active" %}
    {% if not active %}
    {% set show_active = '' %}
    {% endif %}
    <div class="tab-pane fade {{show_active}}" id="{{name}}" role="tabpanel" aria-labelledby="{{name}}-tab"></div>
{% endmacro %}


{% block margin_content %}
<form method="POST" id="modelconfig" action="/models/{{action}}">
    <ul class="nav nav-tabs my-2" id="paramCats" role="tablist">
        {{ render_tab_header('general', 'General', true) }}

        {{ render_tab_header('pre-processing', 'Pre-Processing') }}
        {{ render_tab_header('classifier', 'Classifier') }}

        {{ render_tab_header('classifiers', 'Ensemble Classifiers') }}
        {{ render_tab_header('meta-classifier', 'Ensemble Meta Classifier') }}
        
        {{ render_tab_header('training', 'Training') }}
    </ul>

    <div class="tab-content" id="paramCatsContent">
        {{ render_tab('general', true) }}
        {{ render_tab('pre-processing') }}
        {{ render_tab('classifier') }}
        {{ render_tab('classifiers') }}
        {{ render_tab('meta-classifier') }}
        {{ render_tab('training') }}
    </div>

    <hr/>
    <input type="submit" value="Save Configuration" class="my-2">

</form>
{% endblock %}
{% block scripts %}
{{ super() }}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
<script src="{{url_for('static', filename='model_form.js')}}"></script>
<script>
const data = {{field_configs|tojson|safe}}
const defaults = {{defaults|tojson|safe}}
function onDocReady() {
    tabs = ["general", "training", "classifier", "pre-processing", "classifiers", "meta-classifier"]
    tabs.forEach(tab => {
        document.getElementById(tab).innerHTML = generate_tab(tab, data, defaults)
    })
}
onDocReady()
</script>

<script>
// these are linked up through the field_configs.json
function modelModeChanged() {
    console.log("model mode changed, is now: " + document.getElementById("gen_model_mode").value)
}
function useEarlyStoppingChanged() {
    console.log("use early stopping changed, is now: " + document.getElementById("train_use_early_stopping").checked)
}
function classifierChanged(classifier_element) {
    // get prefix
    prefix = classifier_element[0].id.split('_')
    prefix.pop()
    prefix = prefix.join('_')

    // get classifier
    class_selected = classifier_element[0].value

    // get div with the hparams
    div_id = prefix + "_hparams_div"
    div_element = document.getElementById(div_id)

    // size
    size = "large"
    if (prefix == "single") size = "small";
    if (prefix == "stacker") size = "small";

    div_element.innerHTML = get_hparams_for(class_selected, prefix, size, defaults)
}
function nrHiddenLayersChanged(nr_element) {
    // todo
    console.log(nr_element)
}
function optimizerChanged(optimizer_element) {
    // todo
    console.log(optimizer_element)
}
function nrOfConvChanged(nr_element) {
    // todo
    console.log(nr_element)
}
function inmodeChanged(inmode_element) {
    // get prefix
    prefix = inmode_element[0].id.split('_')
    prefix.pop()
    prefix = prefix.join('_')

    // get input mode
    inmode_selected = inmode_element[0].value

    // get div with the params
    div_id = prefix + "_params_div"
    div_element = document.getElementById(div_id)

    // size
    size = "large"
    if (prefix == "single") size = "small";
    // stacker input mode is currently not supported
    // if (prefix == "stacker") size = "small";

    div_element.innerHTML = get_params_for(inmode_selected, prefix, size, defaults)
}
</script>

{% endblock %}