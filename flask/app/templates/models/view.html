{% extends 'base.html' %}

{% block subtitle %}View ML Model {{ name }}{% endblock %}

{% block margin_content %}
<h3>Viewing Model: {{name}}</h3>

{% for key in model %}
    {% if key == 'ensemble classifiers' %}
    <div class="card m-2">
        <div class="card-body">
            <h3>{{key.title()}}</h3>
            {% for e_model in model[key] %}
            <div class="row">
                <div class="col-sm-6">
                    <h4>Pre-Processing</h4>
                    <div>Input Mode: {{e_model['input-mode']}}</div>
                    <div>Input Mode Parameters:</div>
                    <ul>
                        {% if e_model['params'] %}
                        {% for param in e_model['params'] %}
                        <li>{{param}}: {{e_model['params'][param]}}</li>
                        {% endfor %}
                        {% endif %}
                    </ul>
                </div>
                <div class="col-sm-6">
                    <h4>Classifier</h4>
                    <div>Classifier: {{e_model['classifier']}}</div>
                    <div>Classifier Hyper-Parameters:</div>
                    <ul>
                        {% if e_model['hyper-params'] %}
                        {% for hparam in e_model['hyper-params'] %}
                        <li>{{hparam}}: {{e_model['hyper-params'][hparam]}}</li>
                        {% endfor %}
                        {% endif %}
                    </ul>
                </div>
            </div>
            <hr />
            {% endfor %}
        </div>
    </div>
    {% elif key == 'meta classifier' %}
    <div class="card m-2">
        <div class="card-body">
            <h3>{{key.title()}}</h3>
            <div>Classifier: {{model[key]['classifier']}}</div>
            <div>Use Concatenation: {{model[key]['use-concat']}}</div>
            <div>No Matrix: {{model[key]['no-matrix']}}</div>
            <div>Hyper-Parameters:</div>
            {% for hp_class in model[key]['hyper-params'] %}
            <ul>
                {% for hparam in model[key]['hyper-params'][hp_class] %}
                <li>{{hparam}}: {{model[key]['hyper-params'][hp_class][hparam]}}</li>
                {% endfor %}
            </ul>
            {% endfor %}
        </div>
    </div>
    {% elif key == 'classifier' %}
    <div class="card m-2">
        <div class="card-body">
            <h3>{{key.title()}}</h3>
            <div>Classifier: {{model[key]['classifier']}}</div>
            <div>Hyper-Parameters:</div>
            {% for hp_class in model[key]['hyper-params'] %}
            <ul>
                {% for hparam in model[key]['hyper-params'][hp_class] %}
                <li>{{hparam}}: {{model[key]['hyper-params'][hp_class][hparam]}}</li>
                {% endfor %}
            </ul>
            {% endfor %}
        </div>
    </div>
    {% elif key == 'pre-processing' %}
    <div class="card m-2">
        <div class="card-body">
            <h3>{{key.title()}}</h3>
            <div>Input Mode: {{model[key]['input-mode']}}</div>
            <div>Input Mode Parameters:</div>
            {% for p_inmode in model[key]['params'] %}
            <ul>
                {% for param in model[key]['params'][p_inmode] %}
                <li>{{param}}: {{model[key]['params'][p_inmode][param]}}</li>
                {% endfor %}
            </ul>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="card m-2">
        <div class="card-body">
            <h3>{{key.title()}}</h3>
            <ul>
                {% for option in model[key] %}
                <li>{{option}}: {{model[key][option]}}</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}
{% endfor %}

<div>
    <p class="my-2">Last trained: {{ last_trained }}</p>
    {% if last_trained != 'Never' %}
    <p class="my-2">Performance (version {{version_count}}): {{performance}}</p>
    {% endif %}
    {% if class_prec %}
        <p class="my-2">Class Precision:</p>
        <ul>
        {% for label in class_prec %}
            <li>{{label}}: {{class_prec[label][0]}}</li>
        {% endfor %}
        </ul>
    {% endif %}
</div>
<div>
    <h3>Actions</h3>
    <button type="button" onclick="trainModel()" class="btn btn-primary my-2">
        (Re)train Model
    </button>
    <form method="GET" id="editmodel" action="{{ url_for('models.editform', model=id) }}">
        <input type="submit" value="Edit Model Configuration" class="btn btn-primary my-2">
    </form>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
function trainModel() {
    fetch('/login/isloggedin')
    .then(e => {
        e.json()
        .then(data => {
            if (!data['is logged in']) {
                alert('You are not logged in! Without logging in, you cannot save edited model configuraton data. Please log in before submitting the model form.')
            }
            else {
                url = `{{ url_for('models.train', model=id) }}`
                fetch(url, {method: "POST"})
                    .then(e => {
                        console.log('Reloading')
                        location.reload()
                    })
            }
        })
    })
}
</script>
{% endblock %}